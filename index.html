<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML Executor</title>
  <style>
    /* (your existing styles here…) */
  </style>
</head>
<body>
  <h1>HTML Executor</h1>
  <div class="controls">
    <!-- (your existing controls here…) -->
  </div>

  <script>
    // 0. Immediately open a blank window. This must run synchronously to avoid popup blockers.
    const newWin = window.open('about:blank', '_blank');
    if (!newWin) {
      console.warn('Popup blocked! Please allow popups for this site to auto-open the executor.');
    }

    // Utility to open arbitrary HTML in *another* new tab (for your controls)
    function openInNewTab(htmlContent) {
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(() => URL.revokeObjectURL(url), 60_000);
    }

    // (Your existing upload / paste / fetch handlers here…)
    // …

    // 1. Once the DOM is ready, serialize this very page and load it into the already-opened window.
    document.addEventListener('DOMContentLoaded', () => {
      if (!newWin) return;   // nothing to do if it was blocked

      // Serialize DOCTYPE + full HTML
      const doctype = new XMLSerializer().serializeToString(document.doctype);
      const html    = doctype + '\n' + document.documentElement.outerHTML;

      // Create a Blob URL and redirect the new window there
      const blobUrl = URL.createObjectURL(new Blob([html], { type: 'text/html' }));
      newWin.location.href = blobUrl;

      // Clean up when done
      setTimeout(() => URL.revokeObjectURL(blobUrl), 60_000);
    });
  </script>
</body>
</html>
